<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MiniBattle 3x3</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="img/skins/spikly.png" />
</head>
<body class="home text-white flex flex-col min-h-screen bg-gradient-to-br from-[#0f2027] to-[#2c5364]">

  <header class="glass flex items-center justify-between p-3 border-b border-white/10">
    <div class="flex items-center gap-2">
      <img id="user-photo" class="w-9 h-9 rounded-full border-2 border-cyan-400" />
      <span id="user-name" class="text-sm font-semibold"></span>
    </div>
    <div class="flex items-center gap-1 text-sm text-gray-200">
      üí∞ <span id="balance">0</span>
    </div>
  </header>

  <main id="app" class="flex-1 overflow-hidden relative">
    <section id="screen-home" class="p-4 text-center"></section>
    <section id="screen-battle" class="hidden p-4 text-center"></section>
    <section id="screen-skins" class="hidden p-4 text-center"></section>
    <section id="screen-shop" class="hidden p-4 text-center"></section>
  </main>

  <nav class="flex justify-around text-sm py-2 border-t border-white/10 bg-black/40 backdrop-blur-lg">
    <button id="btn-home">üè† –î–æ–º</button>
    <button id="btn-skins">üé≠ –°–∫–∏–Ω—ã</button>
    <button id="btn-shop">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
  </nav>

  <script type="module" src="./js/app.js"></script>
</body>
</html>
<script type="module">
import { cards, getOwnedSkins } from './js/skins.js';
import { initUser } from './js/utils.js';
initUser();

const screenHome = document.getElementById('screen-home');
const screenBattle = document.getElementById('screen-battle');
const body = document.body;
const countdownEl = document.getElementById('countdown');
const battleArea = document.getElementById('battle-area');
const battleLog = document.getElementById('battle-log');
const rankImg = document.getElementById('rank-img');
const rankLevel = document.getElementById('rank-level');
const expBar = document.getElementById('exp-bar');
const expText = document.getElementById('exp-text');
const balanceEl = document.createElement('span');
balanceEl.className = "ml-auto text-sm text-yellow-300 font-semibold";
document.querySelector('header').appendChild(balanceEl);

// --- —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ---
function loadPlayerData() {
  const stored = JSON.parse(localStorage.getItem("playerData") || "{}");
  return {
    level: stored.level || 1,
    exp: stored.exp || 0,
    balance: stored.balance || 0
  };
}
function savePlayerData(data) {
  localStorage.setItem("playerData", JSON.stringify(data));
}
let playerData = loadPlayerData();

// —Ä–∞–Ω–≥–∏ –ø–æ —É—Ä–æ–≤–Ω—é
function getRankImage(level) {
  if (level <= 10) return "img/ranks/bronze.png";
  if (level <= 20) return "img/ranks/silver.png";
  if (level <= 30) return "img/ranks/gold.png";
  if (level <= 40) return "img/ranks/plat.png";
  return "img/ranks/diamond.png";
}

// –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
function updatePlayerUI() {
  rankImg.src = getRankImage(playerData.level);
  rankLevel.textContent = playerData.level;
  balanceEl.textContent = `üí∞ ${playerData.balance}`;
  const nextLevelExp = playerData.level * 100;
  expText.textContent = `‚≠ê ${playerData.exp} / ${nextLevelExp}`;
  expBar.style.width = Math.min(100, (playerData.exp / nextLevelExp) * 100) + "%";
}
updatePlayerUI();

// –≥–µ—Ä–æ–π
const hero = (getOwnedSkins()[0] || cards[0]);
document.getElementById('hero-img').src = hero.image;
document.getElementById('hero-info').textContent = `${hero.type} ‚Ä¢ HP: ${hero.hp} ‚Ä¢ –£—Ä–æ–Ω: ${hero.attack} ‚Ä¢ –©–∏—Ç: ${hero.defense}`;

// –±–æ–π (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
function makeNewStats() {
  return {
    player: { hp: hero.hp, dmg: hero.attack, def: hero.defense },
    bot: { hp: 1000, dmg: 150, def: 60 }
  };
}
let state = makeNewStats();

function setHPDisplays() {
  document.getElementById('player-hp').textContent = `‚ù§Ô∏è ${Math.max(0, Math.floor(state.player.hp))}`;
  document.getElementById('bot-hp').textContent = `‚ù§Ô∏è ${Math.max(0, Math.floor(state.bot.hp))}`;
}

function showDamage(containerEl, dmg) {
  const dmgEl = document.createElement('div');
  dmgEl.className = 'damage-text';
  dmgEl.textContent = `-${dmg}`;
  dmgEl.style.left = '50%';
  dmgEl.style.transform = 'translateX(-50%)';
  dmgEl.style.top = '8px';
  containerEl.appendChild(dmgEl);
  setTimeout(()=> dmgEl.remove(), 950);
}

function clearBattleVisuals() {
  battleLog.textContent = '';
  document.querySelectorAll('.damage-text').forEach(n => n.remove());
  document.getElementById('player').style.animation = '';
  document.getElementById('bot').style.animation = '';
}

document.getElementById('toBattle').onclick = async () => {
  state = makeNewStats();
  clearBattleVisuals();
  showScreen('screen-battle');
  body.classList.remove('home');
  body.classList.add('battle');
  setHPDisplays();
  battleArea.classList.add('hidden');
  for (let i = 5; i >= 0; i--) {
    countdownEl.textContent = i === 0 ? '–°—Ç–∞—Ä—Ç!' : `–°—Ç–∞—Ä—Ç —á–µ—Ä–µ–∑ ${i}...`;
    await new Promise(r => setTimeout(r, 1000));
  }
  countdownEl.textContent = '';
  battleArea.classList.remove('hidden');
  startAutoBattle();
};

function showScreen(id) {
  const screens = ['screen-home','screen-battle'];
  screens.forEach(sid => {
    const el = document.getElementById(sid);
    if (sid === id) {
      el.classList.remove('hidden');
      setTimeout(()=> el.classList.add('active'), 20);
    } else {
      el.classList.remove('active');
      setTimeout(()=> el.classList.add('hidden'), 250);
    }
  });
}

// –±–æ–π
async function startAutoBattle() {
  const playerEl = document.getElementById('player');
  const botEl = document.getElementById('bot');
  document.getElementById('player-img').src = hero.image;
  document.getElementById('bot-img').src = cards[1]?.image || 'img/skins/bullit.png';

  setHPDisplays();
  let turn = 0;

  while (state.player.hp > 0 && state.bot.hp > 0) {
    await new Promise(r => setTimeout(r, 700));
    if (turn % 2 === 0) {
      playerEl.style.animation = "attackPlayer 600ms ease";
      const dmg = Math.max(1, Math.round(state.player.dmg - state.bot.def));
      state.bot.hp = Math.max(0, state.bot.hp - dmg);
      showDamage(botEl, dmg);
      setHPDisplays();
      battleLog.textContent = `–¢—ã –Ω–∞–Ω—ë—Å ${dmg} —É—Ä–æ–Ω–∞`;
    } else {
      botEl.style.animation = "attackBot 600ms ease";
      const dmg = Math.max(1, Math.round(state.bot.dmg - state.player.def));
      state.player.hp = Math.max(0, state.player.hp - dmg);
      showDamage(playerEl, dmg);
      setHPDisplays();
      battleLog.textContent = `–ë–æ—Ç –Ω–∞–Ω—ë—Å ${dmg} —É—Ä–æ–Ω–∞`;
    }

    await new Promise(r => setTimeout(r, 650));
    playerEl.style.animation = '';
    botEl.style.animation = '';

    if (state.bot.hp <= 0 || state.player.hp <= 0) break;
    turn++;
  }

  setHPDisplays();
  const victory = state.bot.hp <= 0 && state.player.hp > 0;
  battleLog.textContent = victory ? "üèÜ –ü–æ–±–µ–¥–∞!" : "üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ!";

  if (victory) {
    const coins = Math.floor(Math.random() * 10) + 1;
    const xp = Math.floor(Math.random() * 10) + 1;
    playerData.balance += coins;
    playerData.exp += xp;
    const nextLevelExp = playerData.level * 100;
    if (playerData.exp >= nextLevelExp) {
      playerData.exp -= nextLevelExp;
      playerData.level++;
      battleLog.textContent += `\n‚ú® –ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å: ${playerData.level}!`;
    }
    savePlayerData(playerData);
    updatePlayerUI();

    const rewardMsg = document.createElement('div');
    rewardMsg.className = "absolute bottom-10 bg-white/90 text-black px-4 py-2 rounded-xl shadow font-semibold";
    rewardMsg.textContent = `+${coins} üí∞  +${xp}‚≠ê –æ–ø—ã—Ç–∞`;
    document.body.appendChild(rewardMsg);
    setTimeout(()=> rewardMsg.remove(), 2000);
  }

  await new Promise(r => setTimeout(r, 2000));
  clearBattleVisuals();
  await new Promise(r => setTimeout(r, 600));

  showScreen('screen-home');
  body.classList.remove('battle');
  body.classList.add('home');
  state = makeNewStats();
  setHPDisplays();
  setTimeout(()=> { battleLog.textContent = ''; countdownEl.textContent = ''; }, 200);
}
</script>
