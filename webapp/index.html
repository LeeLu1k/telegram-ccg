<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mini Battle 3x3 ‚Äî –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { overflow:hidden; color:white; font-family:Inter, sans-serif; transition:background 1s ease; }
  body.home { background: linear-gradient(-45deg,#0f2027,#203a43,#2c5364); background-size:400% 400%; animation:gradientMove 15s ease infinite; }
  body.battle { background: linear-gradient(180deg,#87ceeb,#e0f7ff); }
  @keyframes gradientMove { 0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%} }

  .cloud { position:absolute; background:rgba(255,255,255,0.6); border-radius:50%; filter:blur(10px); animation:floatCloud 40s linear infinite; }
  @keyframes floatCloud { from{transform:translateX(-200px)} to{transform:translateX(120vw)} }

  .fade { opacity:0; transform:scale(.97); transition: opacity .45s ease, transform .45s ease; }
  .fade.active { opacity:1; transform:scale(1); }

  @keyframes attackPlayer { 0%{transform:translateX(0)}30%{transform:translateX(40px)}60%{transform:translateX(-10px)}100%{transform:translateX(0)} }
  @keyframes attackBot { 0%{transform:translateX(0)}30%{transform:translateX(-40px)}60%{transform:translateX(10px)}100%{transform:translateX(0)} }

  .damage-text { position:absolute; font-weight:700; font-size:1rem; color:#ff3b30; pointer-events:none; opacity:0; transform:translateY(0); animation:floatUp 900ms ease forwards; text-shadow:0 2px 8px rgba(0,0,0,.5); }
  @keyframes floatUp { 0%{opacity:1;transform:translateY(0)} 100%{opacity:0;transform:translateY(-36px)} }

  .glass { background:rgba(255,255,255,.06); backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,.08); box-shadow:0 8px 30px rgba(0,0,0,.35); }
</style>
</head>
<body class="home flex flex-col min-h-screen">

<header class="glass flex items-center gap-3 p-4 border-b border-white/10">
  <img id="user-photo" class="w-10 h-10 rounded-full border-2 border-cyan-400" />
  <span id="user-name" class="text-lg font-semibold"></span>
</header>

<main id="app" class="flex-1 relative overflow-hidden">
  <!-- HOME -->
  <section id="screen-home" class="fade active absolute inset-0 flex flex-col items-center justify-center text-center p-6">
    <div class="glass p-6 rounded-2xl w-full max-w-sm">
      <h1 class="text-3xl font-bold text-cyan-400 mb-3">–¢–≤–æ–π –≥–µ—Ä–æ–π</h1>
      <img id="hero-img" src="img/skins/spikly.png" class="mx-auto w-24 h-24 mb-3 rounded-full border-2 border-cyan-400" />
      <p id="hero-info" class="text-gray-300 mb-4">HP: ‚Äî ‚Ä¢ –£—Ä–æ–Ω: ‚Äî ‚Ä¢ –©–∏—Ç: ‚Äî</p>
      <button id="toBattle" class="bg-gradient-to-r from-cyan-500 to-blue-500 py-3 px-10 rounded-xl font-semibold">‚öîÔ∏è –í –±–æ–π</button>
    </div>
  </section>

  <!-- BATTLE -->
  <section id="screen-battle" class="fade absolute inset-0 flex flex-col items-center justify-center text-center hidden p-6">
    <div class="cloud w-32 h-20 top-20 left-[-150px]" style="animation-delay:0s"></div>
    <div class="cloud w-40 h-24 top-40 left-[-200px]" style="animation-delay:10s"></div>
    <div class="cloud w-28 h-18 top-60 left-[-250px]" style="animation-delay:20s"></div>

    <h2 class="text-2xl text-blue-700 font-bold mb-4 drop-shadow-lg">‚òÅÔ∏è –ù–µ–±–µ—Å–Ω–∞—è –ê—Ä–µ–Ω–∞</h2>
    <div id="countdown" class="text-3xl font-bold text-gray-800 mb-4"></div>

    <div id="battle-area" class="hidden w-full max-w-md flex justify-between items-center px-6 relative">
      <div id="player" class="glass p-4 rounded-xl w-[45%] relative">
        <img id="player-img" src="img/skins/spikly.png" class="w-20 h-20 rounded-full border-2 border-cyan-400 mx-auto mb-2" />
        <p id="player-hp" class="text-gray-900">‚ù§Ô∏è 0</p>
      </div>
      <div id="bot" class="glass p-4 rounded-xl w-[45%] relative">
        <img id="bot-img" src="img/skins/bullit.png" class="w-20 h-20 rounded-full border-2 border-rose-400 mx-auto mb-2" />
        <p id="bot-hp" class="text-gray-900">‚ù§Ô∏è 0</p>
      </div>
    </div>

    <p id="battle-log" class="text-gray-900 mt-6 text-sm min-h-[1.6rem]"></p>
  </section>
</main>

<footer class="text-center text-gray-400 text-xs py-3 glass border-t border-white/10">¬© 2025 MiniBattle Studio</footer>

<script type="module">
  import { cards } from './js/skins.js';
  import { initUser } from './js/utils.js';
  // init telegram info
  initUser();

  // elements
  const screenHome = document.getElementById('screen-home');
  const screenBattle = document.getElementById('screen-battle');
  const body = document.body;
  const countdownEl = document.getElementById('countdown');
  const battleArea = document.getElementById('battle-area');
  const battleLog = document.getElementById('battle-log');

  const hero = cards[0]; // –ø–æ–¥–∞—Ä–æ–∫/–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  document.getElementById('hero-img').src = hero.image;
  document.getElementById('hero-info').textContent = `${hero.type} ‚Ä¢ HP: ${hero.hp} ‚Ä¢ –ê—Ç–∞–∫–∞: ${hero.attack} ‚Ä¢ –©–∏—Ç: ${hero.defense}`;

  // reset (–Ω–∞ –∫–∞–∂–¥—ã–π —Å—Ç–∞—Ä—Ç –±–æ—è –¥–æ–ª–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
  function makeNewStats() {
    return {
      player: { hp: hero.hp, dmg: hero.attack, def: hero.defense },
      bot: { hp: 1000, dmg: 150, def: 60 }
    };
  }

  let state = makeNewStats();

  // helper: show screen by id (SPA)
  function showScreen(id) {
    const screens = ['screen-home','screen-battle'];
    screens.forEach(sid => {
      const el = document.getElementById(sid);
      if (sid === id) {
        el.classList.remove('hidden');
        setTimeout(()=> el.classList.add('active'), 20);
      } else {
        el.classList.remove('active');
        setTimeout(()=> el.classList.add('hidden'), 250);
      }
    });
  }

  // place HP safely (never < 0). Also hide negative glitch.
  function setHPDisplays() {
    const ph = Math.max(0, Math.floor(state.player.hp));
    const bh = Math.max(0, Math.floor(state.bot.hp));
    document.getElementById('player-hp').textContent = `‚ù§Ô∏è ${ph}`;
    document.getElementById('bot-hp').textContent = `‚ù§Ô∏è ${bh}`;
  }

  // show floating damage near element (element is container div)
  function showDamage(containerEl, dmg) {
    const rect = containerEl.getBoundingClientRect();
    // create damage element positioned relative to container
    const dmgEl = document.createElement('div');
    dmgEl.className = 'damage-text';
    dmgEl.textContent = `-${dmg}`;
    // place near top-center of container
    dmgEl.style.left = '50%';
    dmgEl.style.transform = 'translateX(-50%)';
    dmgEl.style.top = '8px';
    containerEl.appendChild(dmgEl);
    // remove after animation
    setTimeout(()=> { if (dmgEl && dmgEl.parentNode) dmgEl.remove(); }, 950);
  }

  // main transition: home -> battle
  document.getElementById('toBattle').onclick = async () => {
    // reset any previous state
    state = makeNewStats();
    clearBattleVisuals();

    // change screen and body class
    showScreen('screen-battle');
    body.classList.remove('home'); body.classList.add('battle');

    // initial hp display
    setHPDisplays();

    // —Å–Ω–∞—á–∞–ª–∞ —Å–∫—Ä—ã–≤–∞–µ–º –±–æ–π (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –≤–∏–¥–Ω–æ –ø—Ä–∏ –æ—Ç—Å—á—ë—Ç–µ)
    battleArea.classList.add('hidden');
    
    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å—á—ë—Ç—á–∏–∫
    for (let i = 5; i >= 0; i--) {
      countdownEl.textContent = i === 0 ? '–°—Ç–∞—Ä—Ç!' : `–°—Ç–∞—Ä—Ç —á–µ—Ä–µ–∑ ${i}...`;
      await new Promise(r => setTimeout(r, 1000));
    }
    
    // —É–±–∏—Ä–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –∏ –≤–∫–ª—é—á–∞–µ–º –∞—Ä–µ–Ω—É
    countdownEl.textContent = '';
    battleArea.classList.remove('hidden');
    startAutoBattle();

    countdownEl.textContent = '';
    startAutoBattle();
  };

  // remove any lingering damage texts/logs
  function clearBattleVisuals() {
    battleLog.textContent = '';
    // remove existing damage elements if any
    document.querySelectorAll('.damage-text').forEach(n => n.remove());
    // reset animations
    document.getElementById('player').style.animation = '';
    document.getElementById('bot').style.animation = '';
  }

  async function startAutoBattle() {
    battleArea.classList.remove('hidden');
    // update images (hero and bot)
    document.getElementById('player-img').src = hero.image;
    document.getElementById('bot-img').src = cards[1]?.image || 'img/skins/bullit.png';

    setHPDisplays();

    const playerEl = document.getElementById('player');
    const botEl = document.getElementById('bot');

    let turn = 0;
    // loop until one is dead
    while (state.player.hp > 0 && state.bot.hp > 0) {
      await new Promise(r => setTimeout(r, 700)); // small delay between turns

      if (turn % 2 === 0) {
        // player attack
        playerEl.style.animation = "attackPlayer 600ms ease";
        const dmg = Math.max(1, Math.round(state.player.dmg - state.bot.def));
        state.bot.hp = Math.max(0, state.bot.hp - dmg); // clamp >=0
        showDamage(botEl, dmg);
        setHPDisplays();
        battleLog.textContent = `–¢—ã –Ω–∞–Ω—ë—Å ${dmg} —É—Ä–æ–Ω–∞`;
      } else {
        // bot attack
        botEl.style.animation = "attackBot 600ms ease";
        const dmg = Math.max(1, Math.round(state.bot.dmg - state.player.def));
        state.player.hp = Math.max(0, state.player.hp - dmg);
        showDamage(playerEl, dmg);
        setHPDisplays();
        battleLog.textContent = `–ë–æ—Ç –Ω–∞–Ω—ë—Å ${dmg} —É—Ä–æ–Ω–∞`;
      }

      // wait for animation end then clear animations to allow re-trigger
      await new Promise(r => setTimeout(r, 650));
      playerEl.style.animation = '';
      botEl.style.animation = '';

      // break if someone died
      if (state.bot.hp <= 0 || state.player.hp <= 0) break;
      turn++;
    }

    // final log: ensure hp shows exactly 0 for dead
    setHPDisplays();
    const victory = state.bot.hp <= 0 && state.player.hp > 0;
    battleLog.textContent = victory ? "üèÜ –ü–æ–±–µ–¥–∞!" : "üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ!";

    // pause so player sees result, then auto-return to home and reset everything
    await new Promise(r => setTimeout(r, 2000));

    // cleanup and reset (important: do not persist HP)
    clearBattleVisuals();
    // ensure final displays show 0 (already clamped), but do not save to hero
    document.getElementById('player-hp').textContent = `‚ù§Ô∏è ${Math.max(0, Math.floor(state.player.hp))}`;
    document.getElementById('bot-hp').textContent = `‚ù§Ô∏è ${Math.max(0, Math.floor(state.bot.hp))}`;

    // short delay for UX, then return to home
    await new Promise(r => setTimeout(r, 600));
    // switch back
    showScreen('screen-home');
    body.classList.remove('battle');
    body.classList.add('home');

    // reset stats in memory for next fight
    state = makeNewStats();
    setHPDisplays(); // will reflect reset (player HP back to full in next battle)
    // clear log
    setTimeout(()=> { battleLog.textContent = ''; countdownEl.textContent = ''; }, 200);
  }
</script>
</body>
</html>
