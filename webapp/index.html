<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ĞšĞ°Ñ€Ñ‚Ğ¾Ñ‡Ğ½Ğ°Ñ ĞÑ€ĞµĞ½Ğ° â€” Pixel</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="app">
    <header class="topbar">
      <div class="player">ğŸ‘‘ <span id="playerName">Ğ˜Ğ³Ñ€Ğ¾Ğº</span></div>
      <div class="trophies">ğŸ† <span id="trophies">1200</span></div>
      <div class="gold">ğŸ’° <span id="gold">100</span></div>
    </header>

    <main class="viewport">
      <section class="arena-panel">
        <canvas id="arenaCanvas" width="160" height="96"></canvas>
        <div class="arena-hud">
          <div class="tower left">ğŸ”·</div>
          <div class="river"></div>
          <div class="tower right">ğŸ”¶</div>
        </div>
      </section>

      <section class="deck-panel">
        <div class="deck-title">Ğ¢Ğ²Ğ¾Ñ ĞºĞ¾Ğ»Ğ¾Ğ´Ğ°</div>
        <div id="deckList" class="deck-list">
          <!-- Ğ¼Ğ¸Ğ½Ğ¸-ĞºĞ°Ñ€Ñ‚Ñ‹ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ·Ğ´ĞµÑÑŒ -->
        </div>
      </section>
    </main>

    <nav class="bottombar">
      <button id="battleBtn" class="pixel-btn">âš”ï¸ Ğ‘Ğ¾Ğ¹</button>
      <button id="deckBtn" class="pixel-btn">ğŸƒ ĞšĞ¾Ğ»Ğ¾Ğ´Ğ°</button>
      <button id="clanBtn" class="pixel-btn">ğŸ° ĞšĞ»Ğ°Ğ½</button>
      <button id="shopBtn" class="pixel-btn">ğŸ’ ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½</button>
    </nav>
  </div>

  <!-- ĞœĞ¾Ğ´Ğ°Ğ» Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ° (pixel-style) -->
  <div id="resultModal" class="modal hidden">
    <div class="modal-box">
      <h3 id="resultTitle">ĞŸĞ¾Ğ±ĞµĞ´Ğ°!</h3>
      <p id="resultText">+50 Ğ·Ğ¾Ğ»Ğ¾Ñ‚Ğ°</p>
      <div class="modal-actions">
        <button id="modalOk" class="pixel-btn primary">OK</button>
      </div>
    </div>
  </div>

<script>
/* Pixel UI + Telegram WebApp logic */
const tg = window.Telegram?.WebApp;
const playerNameEl = document.getElementById('playerName');
const goldEl = document.getElementById('gold');
const battleBtn = document.getElementById('battleBtn');
const modal = document.getElementById('resultModal');
const resultTitle = document.getElementById('resultTitle');
const resultText = document.getElementById('resultText');
const modalOk = document.getElementById('modalOk');

let username = 'Ğ˜Ğ³Ñ€Ğ¾Ğº';
if (tg) {
  tg.expand();
  const u = tg.initDataUnsafe?.user;
  if (u) username = u.username ? '@' + u.username : (u.first_name || 'Ğ˜Ğ³Ñ€Ğ¾Ğº');
  playerNameEl.textContent = username;
} else {
  // ĞµÑĞ»Ğ¸ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ Ğ½Ğµ Ğ² Telegram â€” Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ¼Ñ Ğ˜Ğ³Ñ€Ğ¾Ğº
  playerNameEl.textContent = username + ' (Ñ‚ĞµÑÑ‚)';
}

/* Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ */
let gold = parseInt(localStorage.getItem('gold') || '100', 10);
goldEl.textContent = gold;

/* Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ·Ğ¾Ğ»Ğ¾Ñ‚Ğ° Ñ Ğ°Ğ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ */
function updateGold(delta) {
  gold = Math.max(0, gold + delta);
  localStorage.setItem('gold', String(gold));
  goldEl.textContent = gold;
  goldEl.classList.add('flash');
  setTimeout(()=> goldEl.classList.remove('flash'), 500);
}

/* ĞŸÑ€Ğ¾ÑÑ‚Ğ°Ñ Ğ´ĞµĞ¼Ğ¾-ĞºĞ¾Ğ»Ğ¾Ğ´Ğ° (Ğ¼Ğ¸Ğ½Ğ¸-ĞºĞ°Ñ€Ñ‚Ñ‹) */
const deck = [
  { id:1,name:'Ğ’Ğ¾Ğ¸Ğ½',atk:3,def:2},
  { id:2,name:'Ğ›ÑƒÑ‡Ğ½Ğ¸Ğº',atk:2,def:1},
  { id:3,name:'ĞœĞ°Ğ³',atk:4,def:1},
  { id:4,name:'Ğ¢Ğ°Ğ½Ğº',atk:1,def:5}
];
const deckList = document.getElementById('deckList');
function renderDeck(){
  deckList.innerHTML = '';
  deck.forEach(c=>{
    const el = document.createElement('div');
    el.className = 'mini-card';
    el.innerHTML = `<div class="card-sprite" data-id="${c.id}"></div>
                    <div class="card-meta"><div class="cname">${c.name}</div>
                    <div class="cstats">ATK ${c.atk} â€¢ DEF ${c.def}</div></div>`;
    deckList.appendChild(el);
  });
}
renderDeck();

/* Battle button: Ñ€Ğ°Ğ½Ğ´Ğ¾Ğ¼Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚, modal */
battleBtn.addEventListener('click', ()=>{
  // Ğ¸Ğ¼Ğ¸Ñ‚Ğ°Ñ†Ğ¸Ñ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¾Ğ¹ Ğ¿Ğ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ¸: play canvas flash
  playBattleFlash();
  setTimeout(()=> {
    const win = Math.random() < 0.55; // 55% win chance (Ğ½Ğ°Ğ¿Ñ€.)
    if (win) {
      updateGold(50);
      showResult(true, '+50 Ğ·Ğ¾Ğ»Ğ¾Ñ‚Ğ°');
    } else {
      updateGold(-20);
      showResult(false, '-20 Ğ·Ğ¾Ğ»Ğ¾Ñ‚Ğ°');
    }
  }, 700);
});

function showResult(isWin, text) {
  modal.classList.remove('hidden');
  modal.classList.add('show');
  resultTitle.textContent = isWin ? 'ğŸ† ĞŸĞ¾Ğ±ĞµĞ´Ğ°!' : 'ğŸ’¥ ĞŸĞ¾Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ';
  resultText.textContent = text;
  // Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ±ĞµĞ´Ğµ Ğ¿Ğ¾Ğ´ÑĞ²ĞµÑ‚Ğ¸Ñ‚ÑŒ Ğ·ĞµĞ»Ñ‘Ğ½Ñ‹Ğ¼, Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¸ â€” ĞºÑ€Ğ°ÑĞ½Ñ‹Ğ¼
  modal.querySelector('.modal-box').classList.toggle('win', isWin);
  modal.querySelector('.modal-box').classList.toggle('lose', !isWin);
}

modalOk.addEventListener('click', ()=> {
  modal.classList.remove('show');
  modal.classList.add('hidden');
});

/* Arena pixel drawing: low-res canvas scaled up (pixel art) */
const canvas = document.getElementById('arenaCanvas');
const ctx = canvas.getContext('2d');
function drawArena() {
  // tiny pixel grid: 40x24 (we set 160x96 but think in 40x24)
  const w = 40, h = 24;
  const off = document.createElement('canvas');
  off.width = w; off.height = h;
  const octx = off.getContext('2d');

  // sky / grass blocks
  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      if (y < 6) octx.fillStyle = '#79b7ff'; // sky
      else if (y < 10) octx.fillStyle = '#7fd3a4'; // light grass
      else if (y < 18) octx.fillStyle = '#4caf50'; // main field
      else octx.fillStyle = '#3b7c3b';
      octx.fillRect(x,y,1,1);
    }
  }
  // river center
  for(let x=12;x<28;x++){
    for(let y=10;y<14;y++){
      octx.fillStyle = '#3aa0ff';
      octx.fillRect(x,y,1,1);
    }
  }
  // towers (left/right)
  for(let y=6;y<12;y++){
    octx.fillStyle = '#6b4c2b';
    octx.fillRect(3,y,3,1);
    octx.fillRect(w-6,y,3,1);
  }
  // castle flags
  octx.fillStyle = '#ffdf57';
  octx.fillRect(4,5,1,1);
  octx.fillRect(w-5,5,1,1);

  ctx.imageSmoothingEnabled = false;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(off,0,0,canvas.width,canvas.height);
}
drawArena();

function playBattleFlash(){
  canvas.classList.add('flash-anim');
  setTimeout(()=> canvas.classList.remove('flash-anim'), 350);
}

/* init */
(function init(){
  // ensure gold shown
  goldEl.textContent = gold;
})();
</script>
</body>
</html>
