<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MiniBattle 3x3</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="icon" href="img/skins/spikly.png" />
<style>
  :root { --glass: rgba(255,255,255,.06); --accent: #06b6d4; }
  body { margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; color:#fff; transition:background 1s ease; }
  body.home { background: linear-gradient(-45deg,#0f2027,#203a43,#2c5364); background-size:400% 400%; animation:bgMove 18s ease infinite; }
  body.battle { background: linear-gradient(180deg,#87ceeb,#dbeffd); color:#06202a; }

  @keyframes bgMove { 0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%} }

  .glass { background: var(--glass); backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,.08); box-shadow: 0 10px 30px rgba(0,0,0,.4); }
  header { display:flex; align-items:center; justify-content:space-between; padding:10px 14px; }
  header .left { display:flex; gap:10px; align-items:center; }
  header img { width:36px; height:36px; border-radius:999px; border:2px solid var(--accent); object-fit:cover; }
  main { min-height: calc(100vh - 112px); padding: 14px; display:flex; align-items:center; justify-content:center; position:relative; }

  /* home card */
  .card { width:100%; max-width:420px; padding:18px; border-radius:16px; text-align:center; }
  .hero-img { width:96px; height:96px; border-radius:999px; border:3px solid var(--accent); display:block; margin:0 auto 10px; object-fit:cover; background:#000; }
  .btn { display:inline-block; padding:12px 22px; border-radius:14px; font-weight:600; cursor:pointer; }

  /* nav */
  nav { display:flex; justify-content:space-around; padding:12px 8px; border-top:1px solid rgba(255,255,255,.06); align-items:center; }

  /* battle styles */
  .cloud { position:absolute; background:rgba(255,255,255,0.85); border-radius:50%; filter: blur(10px); z-index:0; }
  @keyframes floatCloud { from{transform:translateX(-30vw)} to{transform:translateX(120vw)} }
  .cloud.small { width:120px; height:60px; top:10%; opacity:.85; }
  .cloud.mid { width:180px; height:80px; top:30%; opacity:.9; }
  .cloud.big { width:260px; height:110px; top:55%; opacity:.8; }

  .arena { width:100%; max-width:420px; display:flex; justify-content:space-between; align-items:center; position:relative; z-index:2; }
  .fighter { width:45%; background:rgba(255,255,255,0.08); border-radius:12px; padding:8px; text-align:center; position:relative; }
  .fighter img { width:72px; height:72px; border-radius:999px; object-fit:cover; display:block; margin:0 auto 6px; transition: transform .28s ease; }
  .hp { font-weight:700; }

  /* animations */
  @keyframes attackPlayer { 0%{transform:translateX(0)}30%{transform:translateX(36px)}60%{transform:translateX(-8px)}100%{transform:translateX(0)} }
  @keyframes attackBot { 0%{transform:translateX(0)}30%{transform:translateX(-36px)}60%{transform:translateX(8px)}100%{transform:translateX(0)} }

  .damage-text { position:absolute; left:50%; transform:translateX(-50%); top:6px; font-weight:800; color:#ff3b30; text-shadow:0 4px 12px rgba(0,0,0,.3); animation: floatUp .9s ease forwards; }
  @keyframes floatUp { 0%{opacity:1; transform:translate(-50%,0)} 100%{opacity:0; transform:translate(-50%,-40px)} }

  /* countdown */
  .countdown { font-size:40px; font-weight:800; margin-bottom:10px; }

  /* responsive */
  @media (max-width:420px){
    .hero-img{width:84px;height:84px}
    header img{width:32px;height:32px}
  }
</style>
</head>
<body class="home">

<header class="glass">
  <div class="left">
    <img id="user-photo" src="img/skins/spikly.png" alt="avatar">
    <div>
      <div id="user-name" class="text-sm font-semibold">–ò–≥—Ä–æ–∫</div>
      <div id="user-rank" class="text-xs text-gray-300">–†–∞–Ω–≥: –ë—Ä–æ–Ω–∑–∞</div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:8px">
    <div class="text-xs text-gray-300">–ë–∞–ª–∞–Ω—Å</div>
    <div id="balance" class="font-semibold">0</div>
  </div>
</header>

<main>
  <!-- HOME -->
  <section id="screen-home" style="width:100%; display:block">
    <div class="card glass">
      <div style="text-align:left; margin-bottom:8px;">
        <div class="text-xs text-gray-300">–£—Ä–æ–≤–µ–Ω—å <span id="level-num">1</span></div>
        <div style="height:8px; background:rgba(0,0,0,0.12); border-radius:8px; overflow:hidden; margin-top:6px;">
          <div id="exp-bar" style="height:8px; width:0%; background:linear-gradient(90deg,var(--accent),#3b82f6);"></div>
        </div>
      </div>

      <img id="hero-img" class="hero-img" src="img/skins/spikly.png" alt="hero" />
      <h2 id="hero-name" class="text-xl font-bold" style="color:var(--accent)">–°–ø–∞–π–∫–ª–∏</h2>
      <p id="hero-desc" class="text-sm text-gray-300">–í–µ—Å—ë–ª—ã–π –∫–∞–∫—Ç—É—Å ‚Äî —Å—Ç—Ä–µ–ª–æ–∫. HP 1200 ‚Ä¢ –£—Ä–æ–Ω 180 ‚Ä¢ –©–∏—Ç 40</p>

      <div style="margin-top:14px">
        <button id="startBattle" class="btn" style="background:linear-gradient(90deg,var(--accent),#3b82f6); color:#042; box-shadow:0 8px 24px rgba(0,0,0,.25)">üéÆ –í –±–æ–π</button>
      </div>
    </div>
  </section>

  <!-- BATTLE SCREEN (rendered into this container) -->
  <section id="screen-battle" style="display:none; width:100%; height:100%; position:relative;">
    <!-- clouds & dynamic content injected by JS -->
    <div id="battle-root" style="position:relative; width:100%; height:100%; display:flex; align-items:center; justify-content:center;"></div>
  </section>
</main>

<nav class="glass" style="position:sticky; bottom:0;">
  <button id="nav-home" class="text-sm">üè† –ì–ª–∞–≤–Ω–∞—è</button>
  <button id="nav-skins" class="text-sm">üé≠ –°–∫–∏–Ω—ã</button>
  <button id="nav-shop" class="text-sm">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
</nav>

<script type="module">
/* single-file app: skins, storage, UI and battle logic
   Place images in img/skins/ and img/ranks/ as previously discussed.
*/

const skins = [
  { id:1, name:"–°–ø–∞–π–∫–ª–∏", type:"–°—Ç—Ä–µ–ª–æ–∫", hp:1200, attack:180, defense:40, price:0, image:"img/skins/spikly.png" },
  { id:2, name:"–ë—É–ª–ª–∏—Ç", type:"–¢–∞–Ω–∫", hp:2000, attack:160, defense:80, price:150, image:"img/skins/bullit.png" }
];

// storage helpers
function loadPlayer(){
  try { return JSON.parse(localStorage.getItem('playerData')) || null; }
  catch(e){ return null; }
}
function savePlayer(obj){ localStorage.setItem('playerData', JSON.stringify(obj)); }

let player = loadPlayer();
if(!player){
  // first run: give starter skin (id 1)
  player = { balance:0, level:1, exp:0, owned:[1], selected:1 };
  savePlayer(player);
}

// Telegram info (if present)
const tg = window.Telegram?.WebApp;
if (tg) { tg.ready(); tg.expand(); }

// DOM refs
const userNameEl = document.getElementById('user-name');
const userPhotoEl = document.getElementById('user-photo');
const balanceEl = document.getElementById('balance');
const levelNumEl = document.getElementById('level-num');
const expBarEl = document.getElementById('exp-bar');
const heroImgEl = document.getElementById('hero-img');
const heroNameEl = document.getElementById('hero-name');
const heroDescEl = document.getElementById('hero-desc');

const screenHome = document.getElementById('screen-home');
const screenBattle = document.getElementById('screen-battle');
const battleRoot = document.getElementById('battle-root');

// init UI
function updateHeaderAndHero(){
  balanceEl.textContent = player.balance;
  levelNumEl.textContent = player.level;
  const next = player.level * 100;
  expBarEl.style.width = Math.max(0, Math.min(100, (player.exp / next) * 100)) + '%';
  const hero = skins.find(s=>s.id === player.selected) || skins[0];
  heroImgEl.src = hero.image; heroNameEl.textContent = hero.name;
  heroDescEl.textContent = `${hero.type} ‚Ä¢ HP: ${hero.hp} ‚Ä¢ –£—Ä–æ–Ω: ${hero.attack} ‚Ä¢ –©–∏—Ç: ${hero.defense}`;
  const user = tg?.initDataUnsafe?.user;
  if(user){ userNameEl.textContent = user.first_name || user.username; if(user.photo_url) userPhotoEl.src = user.photo_url; }
}
updateHeaderAndHero();

// navigation
document.getElementById('nav-home').onclick = ()=>{ showHome(); };
document.getElementById('nav-skins').onclick = ()=>{ alert('–≠–∫—Ä–∞–Ω "–°–∫–∏–Ω—ã" —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç!'); };
document.getElementById('nav-shop').onclick = ()=>{ alert('–ú–∞–≥–∞–∑–∏–Ω —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç!'); };

function showHome(){ screenBattle.style.display='none'; screenHome.style.display='block'; document.body.classList.replace('battle','home'); }
function showBattle(){ screenHome.style.display='none'; screenBattle.style.display='block'; document.body.classList.replace('home','battle'); }

// helper: create cloud elements
function createCloud(cls, leftOffset) {
  const c = document.createElement('div');
  c.className = 'cloud ' + cls;
  c.style.left = leftOffset || '-200px';
  c.style.animationDuration = (30 + Math.random()*30) + 's';
  return c;
}

/* Battle flow: 3s countdown -> show arena with clouds -> animated 1v1 -> reward/save -> back home */

document.getElementById('startBattle').addEventListener('click', async () => {
  // prepare
  const hero = skins.find(s=>s.id===player.selected) || skins[0];
  showBattle();
  battleRoot.innerHTML = ''; // clear

  // background container
  const bg = document.createElement('div');
  bg.style.position='absolute'; bg.style.inset='0'; bg.style.zIndex='0';
  bg.style.background='linear-gradient(180deg,#87ceeb,#dbeffd)';
  battleRoot.appendChild(bg);

  // clouds
  const cloud1 = createCloud('big','-250px'); cloud1.style.top='6%';
  const cloud2 = createCloud('mid','-300px'); cloud2.style.top='28%';
  const cloud3 = createCloud('small','-200px'); cloud3.style.top='56%';
  [cloud1,cloud2,cloud3].forEach(c=>{ c.style.opacity=0.95; c.style.animationName='floatCloud'; battleRoot.appendChild(c); });

  // container for content
  const wrapper = document.createElement('div');
  wrapper.style.position='relative'; wrapper.style.zIndex='2'; wrapper.style.width='100%'; wrapper.style.maxWidth='480px'; wrapper.style.margin='0 auto';
  wrapper.style.padding='20px';
  wrapper.style.boxSizing='border-box';
  battleRoot.appendChild(wrapper);

  // countdown
  const countdown = document.createElement('div');
  countdown.className='countdown';
  countdown.style.textAlign='center'; countdown.style.color='#03353b';
  wrapper.appendChild(countdown);

  // arena
  const arena = document.createElement('div'); arena.className='arena'; arena.style.marginTop='6px';
  wrapper.appendChild(arena);

  // player box
  const playerBox = document.createElement('div'); playerBox.className='fighter';
  const pImg = document.createElement('img'); pImg.src = hero.image;
  const pHp = document.createElement('div'); pHp.className='hp'; pHp.textContent = `‚ù§Ô∏è ${hero.hp}`;
  playerBox.appendChild(pImg); playerBox.appendChild(pHp);
  arena.appendChild(playerBox);

  // bot box
  const botSkin = skins[1] || { image:'img/skins/bullit.png', name:'–ë–æ—Ç' };
  const botBox = document.createElement('div'); botBox.className='fighter';
  const bImg = document.createElement('img'); bImg.src = botSkin.image;
  const bHp = document.createElement('div'); bHp.className='hp'; bHp.textContent = `‚ù§Ô∏è 1000`;
  botBox.appendChild(bImg); botBox.appendChild(bHp);
  arena.appendChild(botBox);

  // log
  const log = document.createElement('div'); log.style.textAlign='center'; log.style.marginTop='12px'; log.style.color='#03353b';
  wrapper.appendChild(log);

  // countdown 3..1
  for (let t=3;t>=1;t--){
    countdown.textContent = t;
    await new Promise(r=>setTimeout(r,1000));
  }
  countdown.textContent = '‚ö° –°—Ç–∞—Ä—Ç!';
  await new Promise(r=>setTimeout(r,700));
  countdown.textContent = '';

  // battle state
  let state = { player: { hp: hero.hp, atk: hero.attack, def: hero.defense }, bot: { hp: 1000, atk: 150, def: 60 } };

  function updateHP(){
    pHp.textContent = `‚ù§Ô∏è ${Math.max(0, Math.floor(state.player.hp))}`;
    bHp.textContent = `‚ù§Ô∏è ${Math.max(0, Math.floor(state.bot.hp))}`;
  }

  function showDamageOnBox(boxEl, dmg){
    const d = document.createElement('div');
    d.className='damage-text';
    d.textContent = `-${dmg}`;
    boxEl.appendChild(d);
    setTimeout(()=>d.remove(),950);
  }

  // single attack animation
  async function doAttack(attacker, defender, atkImg, defBox, name){
    // move forward
    atkImg.style.transform = `translateX(${atkImg===pImg? '36px' : '-36px'}) scale(1.03)`;
    await new Promise(r=>setTimeout(r,220));
    // damage calc
    const dmg = Math.max(1, Math.round(attacker.atk - defender.def/3));
    defender.hp = Math.max(0, defender.hp - dmg);
    showDamageOnBox(defBox, dmg);
    updateHP();
    log.textContent = `${name} –Ω–∞–Ω—ë—Å ${dmg} —É—Ä–æ–Ω–∞`;
    await new Promise(r=>setTimeout(r,420));
    // return
    atkImg.style.transform = `translateX(0) scale(1)`;
    await new Promise(r=>setTimeout(r,260));
  }

  // fight loop
  let turn = 0;
  while (state.player.hp > 0 && state.bot.hp > 0){
    if (turn % 2 === 0){
      await doAttack(state.player, state.bot, pImg, botBox, '–¢—ã');
    } else {
      await doAttack(state.bot, state.player, bImg, playerBox, '–ë–æ—Ç');
    }
    turn++;
  }

  const victory = state.bot.hp <= 0 && state.player.hp > 0;
  log.textContent = victory ? 'üèÜ –ü–æ–±–µ–¥–∞!' : 'üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ!';
  updateHP();

  // reward on victory: coins 1-10, exp 1-10
  if (victory){
    const coins = Math.floor(Math.random()*10)+1;
    const xp = Math.floor(Math.random()*10)+1;
    player.balance += coins;
    player.exp = (player.exp||0) + xp;
    const next = player.level * 100;
    if (player.exp >= next){ player.exp -= next; player.level++; }
    savePlayer(player);
    updateHeaderAndHero();

    const rewardPopup = document.createElement('div');
    rewardPopup.style.position='fixed'; rewardPopup.style.left='50%'; rewardPopup.style.bottom='18%';
    rewardPopup.style.transform='translateX(-50%)'; rewardPopup.style.padding='10px 14px';
    rewardPopup.style.background='white'; rewardPopup.style.color='#012'; rewardPopup.style.borderRadius='12px';
    rewardPopup.style.boxShadow='0 12px 30px rgba(0,0,0,.25)';
    rewardPopup.textContent = `+${coins} üí∞  +${xp} ‚≠ê –æ–ø—ã—Ç–∞`;
    document.body.appendChild(rewardPopup);
    setTimeout(()=>rewardPopup.remove(),1800);
  }

  // auto-return after short pause
  await new Promise(r=>setTimeout(r,1800));
  // cleanup clouds animations by removing them
  battleRoot.innerHTML = '';
  showHome();
  updateHeaderAndHero();
});

// small helper: ensure returned to home on load
showHome();
</script>
</body>
</html>
