<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MiniBattle 3x3</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="img/skins/spikly.png" />
  <style>
    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –±–æ–π ‚Äî "–Ω–∞–ª–∏–≤–∞—é—â–µ–µ—Å—è –Ω–µ–±–æ" */
    #sky-fade {
      position: fixed;
      inset: 0;
      background: linear-gradient(to bottom, #87cefa, #ffffff);
      opacity: 0;
      pointer-events: none;
      z-index: 50;
      transition: opacity 0.5s ease;
    }
    #sky-fade.active {
      opacity: 1;
      animation: skyFade 3s ease forwards;
    }

    @keyframes skyFade {
      0% { opacity: 0; transform: scale(1); }
      40% { opacity: 1; transform: scale(1.05); }
      100% { opacity: 0; transform: scale(1); }
    }

    /* –í—Å–ø–ª—ã–≤–∞—é—â–∏–π —Ç–µ–∫—Å—Ç –æ—Ç—Å—á—ë—Ç–∞ */
    #countdown {
      font-size: 2rem;
      font-weight: bold;
      color: white;
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-shadow: 0 0 10px #000;
    }

    /* –¢–µ–∫—Å—Ç —É—Ä–æ–Ω–∞ */
    .damage-text {
      position: absolute;
      color: #ff4d4d;
      font-weight: bold;
      animation: floatUp 1s ease forwards;
    }

    @keyframes floatUp {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-40px); }
    }
  </style>
</head>
<body class="home text-white flex flex-col min-h-screen bg-gradient-to-br from-[#0f2027] to-[#2c5364]">

  <!-- –≠—Ñ—Ñ–µ–∫—Ç –Ω–µ–±–∞ -->
  <div id="sky-fade"></div>

  <header class="glass flex items-center justify-between p-3 border-b border-white/10">
    <div class="flex items-center gap-2">
      <img id="user-photo" class="w-9 h-9 rounded-full border-2 border-cyan-400" />
      <span id="user-name" class="text-sm font-semibold"></span>
    </div>
    <div class="flex items-center gap-1 text-sm text-gray-200">
      üí∞ <span id="balance">0</span>
    </div>
  </header>

  <main id="app" class="flex-1 overflow-hidden relative">
    <section id="screen-home" class="p-4 text-center">
      <button id="toBattle" class="px-5 py-2 bg-cyan-500 hover:bg-cyan-600 rounded-xl font-semibold mt-5">‚öîÔ∏è –í –±–æ–π!</button>
    </section>
    <section id="screen-battle" class="hidden p-4 text-center relative">
      <div id="countdown"></div>
      <div id="battle-area" class="hidden mt-4">
        <div id="player">üßç‚Äç‚ôÇÔ∏è <span id="player-hp"></span></div>
        <div id="bot" class="mt-4">ü§ñ <span id="bot-hp"></span></div>
        <p id="battle-log" class="mt-4 text-lg font-semibold"></p>
      </div>
    </section>
  </main>

  <nav class="flex justify-around text-sm py-2 border-t border-white/10 bg-black/40 backdrop-blur-lg">
    <button id="btn-home">üè† –î–æ–º</button>
    <button id="btn-skins">üé≠ –°–∫–∏–Ω—ã</button>
    <button id="btn-shop">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
  </nav>

  <script type="module">
    import { cards, getOwnedSkins } from './js/skins.js';
    import { initUser } from './js/utils.js';
    initUser();

    const body = document.body;
    const countdownEl = document.getElementById('countdown');
    const battleArea = document.getElementById('battle-area');
    const battleLog = document.getElementById('battle-log');
    const skyFade = document.getElementById('sky-fade');

    // ‚Äî –û—Ç—Å—á—ë—Ç –ø–µ—Ä–µ–¥ –±–æ–µ–º + —ç—Ñ—Ñ–µ–∫—Ç –Ω–µ–±–∞ ‚Äî
    document.getElementById('toBattle').onclick = async () => {
      skyFade.classList.add('active'); // üå§ –∑–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏ –Ω–µ–±–∞
      await new Promise(r => setTimeout(r, 300)); // –ª–µ–≥–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞

      // –ø–µ—Ä–µ—Ö–æ–¥ –≤ —ç–∫—Ä–∞–Ω –±–æ—è
      showScreen('screen-battle');
      body.classList.remove('home');
      body.classList.add('battle');
      battleArea.classList.add('hidden');

      // –æ—Ç—Å—á—ë—Ç
      for (let i = 3; i >= 0; i--) {
        countdownEl.textContent = i === 0 ? '–°–¢–ê–†–¢!' : `–ë–æ–π —á–µ—Ä–µ–∑ ${i}...`;
        await new Promise(r => setTimeout(r, 1000));
      }

      skyFade.classList.remove('active'); // —É–±—Ä–∞—Ç—å –Ω–µ–±–æ
      countdownEl.textContent = '';
      battleArea.classList.remove('hidden');
      startAutoBattle();
    };

    function showScreen(id) {
      const screens = ['screen-home', 'screen-battle'];
      screens.forEach(sid => {
        const el = document.getElementById(sid);
        el.classList.toggle('hidden', sid !== id);
      });
    }

    // –ü—Ä–∏–º–µ—Ä –±–æ—è (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–π)
    async function startAutoBattle() {
      const playerHP = document.getElementById('player-hp');
      const botHP = document.getElementById('bot-hp');
      let player = 500, bot = 400;

      while (player > 0 && bot > 0) {
        await new Promise(r => setTimeout(r, 800));
        const dmg = Math.floor(Math.random() * 60) + 40;
        bot -= dmg;
        playerHP.textContent = `‚ù§Ô∏è ${Math.max(bot, 0)}`;
        battleLog.textContent = `–¢—ã –Ω–∞–Ω—ë—Å ${dmg} —É—Ä–æ–Ω–∞`;
        if (bot <= 0) break;
        await new Promise(r => setTimeout(r, 800));
        const botDmg = Math.floor(Math.random() * 50) + 30;
        player -= botDmg;
        botHP.textContent = `‚ù§Ô∏è ${Math.max(player, 0)}`;
        battleLog.textContent = `–ë–æ—Ç –Ω–∞–Ω—ë—Å ${botDmg} —É—Ä–æ–Ω–∞`;
      }

      battleLog.textContent = bot <= 0 ? 'üèÜ –ü–æ–±–µ–¥–∞!' : 'üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ!';
      await new Promise(r => setTimeout(r, 2000));
      showScreen('screen-home');
    }
  </script>
</body>
</html>
